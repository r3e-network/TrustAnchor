name: TrustAnchorDeployer (Mainnet)

# SECURITY: Deploys contracts to mainnet.
# - Manual trigger only with dry-run default
# - Uses GitHub environment protection rules
# - Separate mainnet secrets (WIF_MAINNET, RPC_MAINNET)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run in dry-run mode (no actual deployment)"
        required: false
        default: "true"
        type: boolean

permissions:
  contents: read

concurrency:
  group: deployer-mainnet
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: mainnet
      # NOTE: Protection rules (required reviewers, wait timer) must be
      # configured in GitHub UI: Settings > Environments > mainnet
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Install Neo Compiler
        run: dotnet tool install --global Neo.Compiler.CSharp --version 3.8.1

      - name: Restore dependencies
        run: dotnet restore TrustAnchor/TrustAnchor.sln

      - name: Verify Network Configuration
        env:
          RPC: ${{ secrets.RPC_MAINNET }}
        run: |
          echo "Verifying RPC endpoint..."
          if [ -z "$RPC" ]; then
            echo "::error::RPC_MAINNET secret is not configured"
            exit 1
          fi
          echo "RPC configured: ${RPC:0:30}..."

      - name: Dry Run Validation
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "=== DRY RUN MODE ==="
          echo "No transactions will be sent."

      - name: Run Deployer (Dry Run)
        if: ${{ inputs.dry_run == true }}
        env:
          WIF: ${{ secrets.WIF_MAINNET }}
          RPC: ${{ secrets.RPC_MAINNET }}
          OWNER_HASH: ${{ secrets.OWNER_HASH_MAINNET }}
          CONTRACTS_DIR: contract
          DRY_RUN: "true"
        run: |
          echo "Starting dry run deployment..."
          dotnet run --project TrustAnchor/TrustAnchorDeployer

      - name: Run Deployer (Production)
        if: ${{ inputs.dry_run == false }}
        env:
          WIF: ${{ secrets.WIF_MAINNET }}
          RPC: ${{ secrets.RPC_MAINNET }}
          OWNER_HASH: ${{ secrets.OWNER_HASH_MAINNET }}
          CONTRACTS_DIR: contract
        run: |
          echo "=== PRODUCTION DEPLOYMENT ==="
          echo "::warning::Deploying contracts to MAINNET"
          if [ -z "$WIF" ]; then
            echo "::error::WIF_MAINNET not configured"
            exit 1
          fi
          dotnet run --project TrustAnchor/TrustAnchorDeployer

      - name: Deployment Report
        if: always()
        run: |
          echo "=== Deployment Complete ==="
          echo "Review output above for contract addresses."
          echo "Verify contracts on Neo Explorer before proceeding."
